name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, user-customization-for-network-setting-in-test ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run TypeScript compilation check
      run: npm run build

    - name: Run tests
      run: npm test
      env:
        CI: true

    - name: Generate test coverage report
      run: npm run test:cov

    - name: Upload coverage to Codecov (optional)
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false

  build-validation:
    runs-on: ubuntu-latest
    needs: test-and-build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build for production
      run: npm run build

    - name: Validate build artifacts
      run: |
        echo "ğŸ” Validating build artifacts..."
        
        # Check if dist folder was created
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed: dist folder not found"
          exit 1
        fi
        
        # Check for main entry points
        if [ ! -f "dist/main.js" ]; then
          echo "âŒ Build failed: main.js not found"
          exit 1
        fi
        
        # Check if all TypeScript files were compiled
        js_files=$(find dist -name "*.js" | wc -l)
        if [ $js_files -eq 0 ]; then
          echo "âŒ Build failed: No JavaScript files generated"
          exit 1
        fi
        
        echo "âœ… Build validation passed - $js_files files compiled"
        
        # Optional: Check bundle size
        main_size=$(stat -c%s "dist/main.js" 2>/dev/null || stat -f%z "dist/main.js")
        echo "ğŸ“¦ Main bundle size: $(echo $main_size | numfmt --to=iec)B"
        
        # Optional: Validate that the app can start (quick smoke test)
        echo "ğŸš€ Testing application startup..."
        timeout 10 node dist/main.js > startup.log 2>&1 &
        sleep 3
        if ps -p $! > /dev/null; then
          echo "âœ… Application starts successfully"
          kill $! 2>/dev/null || true
        else
          echo "âŒ Application failed to start"
          cat startup.log
          exit 1
        fi

  security-audit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=high

    - name: Check for known vulnerabilities
      run: |
        echo "ğŸ”’ Running security checks..."
        
        # Check for common security issues
        if npm audit --audit-level=critical --json | jq '.vulnerabilities | length' | grep -v '^0$'; then
          echo "âŒ Critical security vulnerabilities found"
          npm audit --audit-level=critical
          exit 1
        fi
        
        echo "âœ… No critical security issues found"